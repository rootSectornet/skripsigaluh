const Pendaftaran = {
  BASE_URL : '',
  CreateSelect : (setting)=>{
    let test = $(setting.el).selectize({
            valueField: 'id_product',
            labelField: 'nama_product',
            searchField: 'nama_product',
            placeholder: setting.label,
            options: [],
            create: false,
            render: {
              option: function(item, escape) {
                if (escape(item.qty) <= 0) {
                        return '<div style="color:red;" class="col-xs-12" style="border-top :1px solid #ccc; padding: 0px !important">' +
                                '<div class="col-xs-6" style="padding-left: 4px;color:red;">' + '<p><strong> Nama :' + escape(item.nama_product) + '</strong></p>' + '</div>' +
                                '<div class="col-xs-6" style="border-left :1px solid #ddd; padding: 0px;">' +
                                    '<div class="col-xs-12" style="padding-left: 4px;">' +
                                        '<p style="margin-bottom: 2px !important; color:red;"><strong> Harga :' + escape(item.harga_jual) + '</strong></p>' +
                                        '<p style="margin-bottom: 2px !important; color:red;"><small>Stock : ' + escape(item.qty) + '</small></p>' +
                                    '</div>' +
                                '</div>' +
                            '</div>';
                }else{
                  return '<div class="col-xs-12" style="border-top :1px solid #ccc; padding: 0px !important">' +
                          '<div class="col-xs-6" style="padding-left: 4px;">' + '<p><strong> Nama :' + escape(item.nama_product) + '</strong></p>' + '</div>' +
                          '<div class="col-xs-6" style="border-left :1px solid #ddd; padding: 0px;">' +
                              '<div class="col-xs-12" style="padding-left: 4px;">' +
                                  '<p style="margin-bottom: 2px !important;"><strong> Harga :' + escape(item.harga_jual) + '</strong></p>' +
                                  '<p style="margin-bottom: 2px !important;"><small>Stock : ' + escape(item.qty) + '</small></p>' +
                              '</div>' +
                          '</div>' +
                      '</div>';
                }
              }
            },
            load: function(query, callback) {
                if (!query.length) return callback();
                $.ajax({
                    url: Pendaftaran.BASE_URL+'gudang/product/jsonpenjualan',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        nama: {nama: query}
                    },
                    error: function() {
                        callback();
                    },
                    success: function(res) {
                        callback(res);
                    }
                });
            },
            onItemAdd: function(value,$item){
              let data = this.options[value];
              $(setting.harga).val(data.harga_jual);
            },
            onDelete : function(value, $item) {
                let data = this.options[value];
                $(setting.harga).val("");
            },
            onItemRemove : function(value, $item) {
                let data = this.options[value];
                $(setting.harga).val("");
            },
            onLoad: function(){
              $(setting.el).val(setting.value);
            }
        });
  }
}




//function
$(()=>{
  'use_strict'

  $('#DbiayaTindakan').click(()=>{
    let id = $('#DbiayaTindakan').attr('data-id')
    form.delete(Pendaftaran.BASE_URL+'pendaftaran/pendaftaran/deleteBiaya/'+id);
  })


  let counter = 0;
  // edit Resep
  $('#editResep').on('click',()=>{
    idResep = $('#editResep').attr('data-id');
    $.ajax({
        url: Pendaftaran.BASE_URL+'pendaftaran/pendaftaran/GetResep/'+idResep,
        type: 'GET',
        ajaxSend: function(){
					Pace.start();
        },
        beforeSend: function(){
					Pace.start();
        },
		    error: function (request, status, error) {
						swal("ERROR!", request.responseText, "error");
		    },
        success: function(res) {
          res = JSON.parse(res)
          $('#edithid').prop('disabled',false);
          $('#table-resep tbody tr').remove()
          $.each(res.detail,(index,value)=>{
            let editRow = $('<tr>')
            let editCols   = ""
            editCols += "<td style='width: 30%'><select  class='form-control' name='s' id='select"+counter+"' required></select>"
            editCols += "<input type='hidden' name='detail["+counter+"][id_product]' value='"+value.id_product+"'</td>"
            editCols += "<td><input type='text' class='form-control qty"+counter+"' name='detail["+counter+"][qty]' required value='"+value.qty+"'></td>"
            editCols += "<td><input type='text' class='form-control signa"+counter+"' name='detail["+counter+"][signa]' required value='"+value.signa+"'></td>"
            editCols += "<td><input type='text' class='form-control harga"+counter+"' name='detail["+counter+"][harga]' required value='"+value.harga_jual+"'></td>"
            editCols += '<td><button type="button" class="ibtnDel btn btn-md btn-danger"><i class="fa fa-trash"></i></button></td>';
            editRow.append(editCols);
            $("#table-resep").append(editRow);
            let test = Pendaftaran.CreateSelect({
              el : '#select'+counter,
              harga : '.harga'+counter,
              value : value.id_product,
              label : value.nama_product
            })
            counter++;
          })

          $('#myModals').modal('show')
        }
    });
  })
  //add resep
  $('#addRow').on('click',()=>{
    let NewRow = $('<tr>')
    let Cols   = ""
    Cols += "<td style='width: 30%'><select  class='form-control' name='detail["+counter+"][id_product]' id='select"+counter+"' required></select></td>"
    Cols += "<td><input type='text' class='form-control qty"+counter+"' name='detail["+counter+"][qty]' required></td>"
    Cols += "<td><input type='text' class='form-control signa"+counter+"' name='detail["+counter+"][signa]' required></td>"
    Cols += "<td><input type='text' class='form-control harga"+counter+"' name='detail["+counter+"][harga]' required></td>"
    Cols += '<td><button type="button" class="ibtnDel btn btn-md btn-danger"><i class="fa fa-trash"></i></button></td>';
    NewRow.append(Cols);
    $("#table-resep").append(NewRow);
    Pendaftaran.CreateSelect({
      el : '#select'+counter,
      harga : '.harga'+counter,
      value : 0,
      label : "Ketik untuk mencari"
    })
    counter++;
  })


  $("#table-resep").on("click", ".ibtnDel", function (event) {
    		  swal({
    		    title: "Are you sure?",
    		    text: "Once deleted, you will not be able to recover this data!",
    		    icon: "warning",
    		    buttons: true,
    		    dangerMode: true,
    		  })
    		  .then((willDelete) => {
    		    if (willDelete){
              $(this).closest("tr").remove();
              counter -= 1
    		    }else {
    		      swal("Your Data is safe!");
              return false;
    		    }
    		  });
  });

  $('#save').click(()=>{
    form.save('#Formsave',Pendaftaran.BASE_URL+'pendaftaran/pendaftaran/SaveResep',null)
  })

  $('#pelunasan').click(()=>{
    let id = $('#pelunasan').attr('data-id');
    $.ajax({
      url : Pendaftaran.BASE_URL+'Kasir/Kasir/BuatPelunasan/'+id,
      type : 'GET',
      ajaxSend: function(){
        Pace.start();
      },
      beforeSend: function(){
        Pace.start();
      },
      error: function (request, status, error) {
          swal("ERROR!", request.responseText, "error");
      },
      success: function(res) {
        res = JSON.parse(res)
          swal({
            icon : "success",
            title: "Information!",
            text: "Success Buat Pelunasan!",}).then(okay => {
                if (okay) {
                     location.reload();
                }
            });
      }

    })
  })

})
